<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mypageMapper">


<!-- 맴버 (맴버 테이블 + 맴버십이름 + 프로필 사진) -->
<resultMap type="Member" id="memberListResultSet">
	<id property="memberId" column="MEMBER_ID"></id>
	<result property="memberName" column="MEMBER_NAME"></result>
	<result property="memberPwd" column="MEMBER_PWD"></result>
	<result property="email" column="EMAIL"></result>
	<result property="nickName" column="NICKNAME"></result>
	<result property="gender" column="GENDER"></result>
	<result property="phone" column="PHONE"></result>
	<result property="address" column="ADDRESS"></result>
	<result property="memberEnrolldate" column="MEMBER_ENROLLDATE"></result>
	<result property="memberModifydate" column="MEMBER_MODIFYDATE"></result>
	<result property="memberAccessdate" column="MEMBER_ACCESSDATE"></result>
	<result property="memberStatus" column="MEMBER_STATUS"></result>
	<result property="memberJoinType" column="MEMBERJOIN_TYPE"></result>
	<result property="reviewStatus" column="REVIEW_STATUS"></result>
	<result property="membershipName" column="MEMBERSHIP_NAME"></result>
	<result property="profileId" column="PROFILE_ID"></result>
	<result property="originalName" column="ORIGINAL_NAME"></result>
	<result property="renameName" column="RENAME_NAME"></result>
	<result property="uploadDate" column="UPLOAD_DATE"></result>
	<result property="file_path" column="FILE_PATH"></result>	
</resultMap>

<resultMap type="Follower" id="followerListResultSet">
	<result property="memberId" column="MEMBER_ID"></result>
	<result property="nickName" column="NICKNAME"></result>
	<result property="renameName" column="RENAME_NAME"></result>
	<result property="followerCount" column="FOLLOWER_COUNT"></result>
	<result property="followingCount" column="FOLLOWING_COUNT"></result>	
</resultMap>

<resultMap type="Restaurant" id="restaurantListResultSet">
		<id property="resId" column="RES_ID" />
		<result property="resCategoryId" column="RES_CATEGORY_ID" />
		<result property="locationId" column="LOCATION_ID" />
		<result property="resName" column="RES_NAME" />
		<result property="resAddress" column="RES_ADDRESS" />
		<result property="resContent" column="RES_CONTENT" />
		<result property="resViewCount" column="RES_VIEWCOUNT" />
		<result property="resTime" column="RES_TIME" />
		<result property="resStatus" column="RES_STATUS" />
		<result property="resCreateDate" column="RES_CREATE_DATE" />
		<result property="resUpdateDate" column="RES_UPDATE_DATE" />
		<result property="resPhone" column="RES_PHONE"/>
		<result property="resImageName" column="RES_IMAGE_NAME"/>
</resultMap>


<resultMap type="Select_Checkin" id="CheckinListResultSet">
	<id property="checkinId" column="CHECKIN_ID" />
	<result property="memberId" column="MEMBER_ID" />
	<result property="resId" column="RES_ID" />
	<result property="checkinCreateDate" column="CHECKIN_CREATE_DATE" />
	<result property="checkinUpdateDate" column="CHECKIN_UPDATE_DATE" />
	<result property="checkinVisitDate" column="CHECKIN_VISIT_DATE" />
	<result property="checkinContent" column="CHECKIN_CONTENT" />
	<result property="resName" column="RES_NAME" />
	<result property="resImage" column="IMAGE_NEW_NAME" />
	<collection property="checkinImageList" column="CHECKIN_ID" ofType="Select_CheckinImage" select="getCheckinImageList"/>
</resultMap>



<resultMap type="Select_CheckinImage" id="CheckinImageListResultSet">
	<id property="imageId" column="IMAGE_ID" />
	<result property="checkinId" column="CHECKIN_ID" />
	<result property="imageNewName" column="IMAGE_NEW_NAME" />
</resultMap>





<!-- Mylist 영은 -->
<resultMap type="Mylist" id="mylistResultSet">
	<id property="resId" column="RES_ID"/>
	<result property="resName" column="RES_NAME"/>
	<result property="resAddress" column="RES_ADDRESS"/>
	<result property="resStatus" column="RES_STATUS"/>
	<result property="imageId" column="IMAGE_ID"/>
	<result property="imageOriginName" column="IMAGE_ORIGIN_NAME"/> 
	<result property="imageNewName" column="IMAGE_NEW_NAME"/>
	<result property="filePath" column="IMAGE_FILEPATH"/>
	<result property="imageCreateDate" column="IMAGE_CREATE_DATE"/>
	<result property="imageLevel" column="IMAGE_LEVEL"/>
	<result property="imageStatus" column="IMAGE_STATUS"/>
	<result property="imageDownloadCount" column="IMAGE_DOWNLOAD_COUNT"/>
	<result property="mlId" column="ML_ID"/>
	<result property="mlTitle" column="ML_TITLE"/>
	<result property="mlUploadDate" column="ML_UPLOAD_DATE"/>
	<result property="modifyDate" column="ML_MODIFY_DATE"/>
	<result property="recommendationTheme" column="RECOMMENDATION_THEME"/>
	<result property="approveTheme" column="APPROVE_THEME"/>
	<result property="memberId" column="MEMBER_ID"/>
	
</resultMap>




<!-- 팔로워 수 카운트 쿼리 -->
 <select id="selectOneFollowCount" parameterType="Member" resultType="_int">
SELECT COUNT(*)
FROM FOLLOW
WHERE FOLLOWING_ID = #{memberId}
</select>
 
<!-- 팔로잉 수 카운트 쿼리 -->
 <select id="selectOneFollowingCount" parameterType="Member" resultType="_int">
SELECT COUNT(*)
FROM FOLLOW
WHERE FOLLOWER_ID = #{memberId}
</select> 

<!-- 리뷰 수 카운트 쿼리 -->
<select id="selectOneReviewCount" parameterType="Member" resultType="_int">
SELECT COUNT(*)
FROM REVIEW
WHERE MEMBER_ID = #{memberId}
</select>

<!-- 마이리스트 수 카운트 쿼리 -->
<select id="selectOneMyListCount" parameterType="Member" resultType="_int">
SELECT COUNT(*)
FROM MYLIST
WHERE MEMBER_ID = #{memberId}
</select>

<!-- 체크인 수 카운트 쿼리 -->
<select id="selectOneCheckInCount" parameterType="Member" resultType="_int">
SELECT COUNT(*)
FROM CHECKIN
WHERE MEMBER_ID = #{memberId}
</select>

<!-- 프로필 사진 조회 쿼리 -->
<select id="selectOneProFile" parameterType="Member" resultType="string">
SELECT RENAME_NAME
FROM PROFILE_IMG
WHERE MEMBER_ID = #{memberId}
</select>

<!-- 프로필 사진 변경 쿼리 -->
<update id="updateMemberProfile" parameterType="Member">
UPDATE PROFILE_IMG SET RENAME_NAME = #{renameName} WHERE MEMBER_ID = #{memberId}
</update>

<!-- 팔로워 조회 쿼리 -->
<select id="selectFollower" parameterType="Member" resultMap="followerListResultSet">

<![CDATA[
SELECT M.MEMBER_ID
        ,M.NICKNAME
        ,PI.RENAME_NAME
        ,(SELECT COUNT(*) FROM FOLLOW WHERE FOLLOWING_ID = M.MEMBER_ID) AS FOLLOWER_COUNT
        ,(SELECT COUNT(*) FROM FOLLOW WHERE FOLLOWER_ID = M.MEMBER_ID) AS FOLLOWING_COUNT
FROM MEMBER M
LEFT JOIN PROFILE_IMG PI ON (M.MEMBER_ID = PI.MEMBER_ID)
WHERE M.MEMBER_ID IN (SELECT FW.FOLLOWER_ID
                        FROM FOLLOW FW
                        LEFT JOIN MEMBER M ON (FW.FOLLOWING_ID = M.MEMBER_ID)
                        WHERE MEMBER_ID = #{memberId})
]]> 
</select>

<!-- 팔로잉 조회 쿼리 -->
<select id="selectFollowing" parameterType="Member" resultMap="followerListResultSet">

<![CDATA[
SELECT M.MEMBER_ID
        ,M.NICKNAME
        ,PI.RENAME_NAME
        ,(SELECT COUNT(*) FROM FOLLOW WHERE FOLLOWING_ID = M.MEMBER_ID) AS FOLLOWER_COUNT
        ,(SELECT COUNT(*) FROM FOLLOW WHERE FOLLOWER_ID = M.MEMBER_ID) AS FOLLOWING_COUNT
FROM MEMBER M
LEFT JOIN PROFILE_IMG PI ON (M.MEMBER_ID = PI.MEMBER_ID)
WHERE M.MEMBER_ID IN (SELECT FW.FOLLOWING_ID
                        FROM FOLLOW FW
                        LEFT JOIN MEMBER M ON (FW.FOLLOWER_ID = M.MEMBER_ID)
                        WHERE MEMBER_ID = #{memberId})
]]> 
</select>


<!-- 닉네임 중복 확인 쿼리 -->
<select id="checkNickNameDup" parameterType="string" resultType="_int">
SELECT COUNT(*)
FROM MEMBER
WHERE NICKNAME = #{nickName}
</select>


<!-- 내정보 수정 쿼리 -->
<update id="updateMemberInfo" parameterType="Member">
	UPDATE MEMBER
	SET MEMBER_PWD=#{memberPwd}
	, NICKNAME=#{nickName}
	, PHONE=#{phone}
	, ADDRESS=#{address}
	WHERE MEMBER_ID = #{memberId}
</update>

<!-- 회원탈퇴 쿼리 -->
<update id="updateMemberWithdrawal" parameterType="Member">
	UPDATE MEMBER
	SET MEMBER_STATUS = 'N'
	WHERE MEMBER_ID = #{memberId}
</update>



<!-- 체크인 등록 페이지에서 음식점 조회 쿼리 -->
<select id="selectListRestaurant" parameterType="string" resultMap="restaurantListResultSet">
SELECT RES_ID, RES_NAME, RES_ADDRESS, RES_IMAGE_NAME 
FROM SELECT_RESTAURANT 
WHERE RES_NAME LIKE '%'||#{resName}||'%' AND RES_STATUS = 'Y'
</select>

<!-- 체크인 테이블에 값 넣는 쿼리 -->
<insert id="insertCheckin" parameterType="Checkin">
INSERT INTO CHECKIN VALUES(
		SEQ_CHECKINID.NEXTVAL
		,#{memberId}
		,#{resId}
		,SYSDATE
		,SYSDATE
		,#{checkinVisitDate}
		,#{checkinContent}
)
</insert>

<!-- 체크인 이미지 테이블에 값을 넣는 쿼리 -->
<insert id="insertCheckinImage" parameterType="CheckinImage">
INSERT INTO CHECKIN_IMAGE VALUES(
	SEQ_IMAGEID.CURRVAL
	,SEQ_CHECKINID.CURRVAL
)
</insert>

<!-- 이미지 테이블에 값을 넣는 쿼리 -->
<insert id="insertImage" parameterType="Image">
INSERT INTO IMAGE VALUES(
	SEQ_IMAGEID.NEXTVAL
	,#{imageOriginName}
	,#{imageNewName}
	,'checkinImage'
	,SYSDATE
	,'1'
	,'Y'
	,'0'
)
</insert>

<!-- 체크인에 등록된 전체 리스트 조회 -->
<select id="selectCheckinList" parameterType="_int" resultMap="CheckinListResultSet">
SELECT CK.*, R.RES_NAME,IMG.IMAGE_NEW_NAME
FROM CHECKIN CK
LEFT JOIN RESTAURANT R ON (CK.RES_ID = R.RES_ID)
LEFT JOIN RES_IMAGE RIMG ON (R.RES_ID = RIMG.RES_ID)
LEFT JOIN IMAGE IMG ON (RIMG.IMAGE_ID = IMG.IMAGE_ID)
WHERE CK.MEMBER_ID = #{memberId}
ORDER BY CK.CHECKIN_ID ASC

</select>

<!-- 체크인 번호와 관련된 이미지 리스트 조회 -->
<select id="getCheckinImageList" resultMap="CheckinImageListResultSet">
SELECT CK.CHECKIN_ID, IMG.IMAGE_ID, IMG.IMAGE_NEW_NAME
FROM CHECKIN CK
LEFT JOIN CHECKIN_IMAGE CIMG ON(CK.CHECKIN_ID = CIMG.CHECKIN_ID)
LEFT JOIN IMAGE IMG ON(CIMG.IMAGE_ID = IMG.IMAGE_ID)
WHERE CK.CHECKIN_ID = #{checkinId}
</select>	

<!-- 체크인 수정페이지에 조회되는 체크인 리스트 -->

<select id="selectModifyCheckinList" parameterType="_int" resultMap="CheckinListResultSet">
SELECT CK.*, R.RES_NAME,IMG.IMAGE_NEW_NAME
FROM CHECKIN CK
LEFT JOIN RESTAURANT R ON (CK.RES_ID = R.RES_ID)
LEFT JOIN RES_IMAGE RIMG ON (R.RES_ID = RIMG.RES_ID)
LEFT JOIN IMAGE IMG ON (RIMG.IMAGE_ID = IMG.IMAGE_ID)
WHERE CK.CHECKIN_ID = #{checkinId}

</select>

<!-- 체크인 테이블 수정 쿼리 -->
<update id="updateCheckin" parameterType="Checkin">
UPDATE CHECKIN
	SET RES_ID = #{resId}
	, CHECKIN_UPDATE_DATE = SYSDATE
	, CHECKIN_VISIT_DATE = #{checkinVisitDate}
	, CHECKIN_CONTENT = #{checkinContent}
	WHERE CHECKIN_ID = #{checkinId}

</update>

<!-- 이미지 테이블 삭제 쿼리 -->
<delete id="deleteImage" parameterType="string">
DELETE FROM IMAGE
WHERE IMAGE_ID = #{imageId}

</delete>

<!-- 체크인 이미지 테이블 삭제 쿼리 -->
<delete id="deleteCheckinImage" parameterType="string">
DELETE FROM CHECKIN_IMAGE
WHERE IMAGE_ID = #{imageId}

</delete>


<!-- 체크인 수정 시 체크인 이미지 테이블에 값을 넣는 쿼리 -->
<insert id="insertCheckinImage2" parameterType="CheckinImage">
INSERT INTO CHECKIN_IMAGE VALUES(
	SEQ_IMAGEID.CURRVAL
	,#{checkinId}
)
</insert>

<!-- 체크인 테이블 삭제 작업 -->
<delete id="deleteCheckin" parameterType="_int">
DELETE FROM CHECKIN
WHERE CHECKIN_ID = #{checkinId}
</delete>

<!-- 체크인 리스트 페이지에서 체크인 이미지 테이블 삭제 작업 -->
<delete id="deleteCheckinImage2" parameterType="_int">
DELETE FROM CHECKIN_IMAGE
WHERE CHECKIN_ID = #{checkinId}
</delete>

<!-- =========================== mylist 영은 ================================================ -->

<!-- mylist 등록 -->
<insert id="insertMylist" parameterType="hashmap">
INSERT INTO MYLIST VALUES
(SEQ_MYLISTID.NEXTVAL,#{themeTitle},SYSDATE,SYSDATE,DEFAULT,NULL,#{themeWriter})
</insert>

<insert id="insertMylistRes" parameterType="string">
	INSERT INTO MYLIST_RES VALUES(#{theme},SEQ_MYLISTID.CURRVAL)
</insert>


</mapper>
